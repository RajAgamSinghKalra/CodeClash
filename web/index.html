<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Live YOLOv8 on the Web</title>
  <style>
    video, canvas {
      position: absolute; left: 0; top: 0;
      transform: scaleX(-1); /* mirror */
    }
  </style>
</head>
<body>
  <video id="video" width="640" height="480" autoplay muted></video>
  <canvas id="canvas" width="640" height="480"></canvas>

  <script>
  const video = document.getElementById('video');
  const canvas = document.getElementById('canvas');
  const ctx = canvas.getContext('2d');

  // 1. Get webcam
  navigator.mediaDevices.getUserMedia({ video: true })
    .then(stream => { video.srcObject = stream; })
    .catch(console.error);

  // 2. Open WebSocket
  const ws = new WebSocket(`ws://${location.host}/ws`);
  ws.onopen = () => {
    console.log('WebSocket connected');
    sendFrameLoop();
  };
  ws.onmessage = msg => {
    // draw the boxes
    const dets = JSON.parse(msg.data);
    ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
    ctx.lineWidth = 2; ctx.strokeStyle = 'lime';
    dets.forEach(d => {
      ctx.strokeRect(d.x1, d.y1, d.x2 - d.x1, d.y2 - d.y1);
      ctx.fillText(d.conf.toFixed(2), d.x1, d.y1 - 5);
    });
  };

  // 3. Capture & send frames
  function sendFrameLoop() {
    const off = document.createElement('canvas');
    off.width = video.videoWidth;
    off.height = video.videoHeight;
    const offCtx = off.getContext('2d');
    offCtx.drawImage(video, 0, 0);
    off.toBlob(blob => {
      const reader = new FileReader();
      reader.onloadend = () => {
        ws.send(reader.result); // sends "data:image/png;base64,...."
      };
      reader.readAsDataURL(blob);
    }, 'image/jpeg', 0.6);
    setTimeout(sendFrameLoop, 66); // ~15 fps
  }
  </script>
</body>
</html>
